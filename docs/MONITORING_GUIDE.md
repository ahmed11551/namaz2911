# Руководство по мониторингу производительности Smart Tasbih API

## Обзор

Модуль мониторинга отслеживает производительность всех эндпоинтов Smart Tasbih API, включая:
- Время ответа (среднее, перцентили P50, P95, P99)
- Количество запросов
- Количество ошибок
- Медленные запросы (>150ms)

## Архитектура

### Компоненты

1. **monitoring.ts** - модуль мониторинга
   - Запись метрик в память
   - Агрегация метрик
   - Вычисление перцентилей

2. **Интеграция в API** - автоматическое измерение всех эндпоинтов
   - Обертка `measurePerformance` для каждого эндпоинта
   - Автоматическое логирование медленных запросов и ошибок

## Метрики

### Производительность

- **avg_duration_ms** - среднее время ответа
- **p50_duration_ms** - медианное время ответа (50-й перцентиль)
- **p95_duration_ms** - 95-й перцентиль (целевой показатель <150ms)
- **p99_duration_ms** - 99-й перцентиль
- **min_duration_ms** - минимальное время
- **max_duration_ms** - максимальное время

### Надежность

- **total_requests** - общее количество запросов
- **success_count** - количество успешных запросов (HTTP < 400)
- **error_count** - количество ошибок (HTTP >= 400)

## Использование

### Просмотр метрик

#### Через API эндпоинт

```bash
curl -X GET \
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \
  https://YOUR_PROJECT.supabase.co/functions/v1/smart-tasbih-api/metrics
```

**Ответ:**
```json
{
  "metrics": [
    {
      "endpoint": "/counter/tap",
      "method": "POST",
      "total_requests": 1250,
      "success_count": 1245,
      "error_count": 5,
      "avg_duration_ms": 85.2,
      "p50_duration_ms": 78,
      "p95_duration_ms": 142,
      "p99_duration_ms": 198,
      "min_duration_ms": 45,
      "max_duration_ms": 250,
      "period_start": "2024-11-29T10:00:00Z",
      "period_end": "2024-11-29T11:00:00Z"
    }
  ]
}
```

#### Через логи Supabase

1. Откройте Supabase Dashboard → Edge Functions → `smart-tasbih-api` → Logs
2. Ищите сообщения:
   - `Slow request detected: ...` - медленные запросы (>150ms)
   - `Error in ...` - ошибки

### Автоматическое логирование

Модуль автоматически логирует:
- **Медленные запросы** (>150ms) - предупреждение в консоль
- **Ошибки** (HTTP >= 400) - ошибка в консоль

## Целевые показатели

### Производительность

- ✅ **P95 < 150ms** - основной целевой показатель
- ✅ **P99 < 300ms** - для критичных операций
- ✅ **Среднее время < 100ms** - общая производительность

### Надежность

- ✅ **Success rate > 99%** - процент успешных запросов
- ✅ **Error rate < 1%** - процент ошибок

## Мониторинг в Production

### Рекомендации

1. **Внешний мониторинг** (рекомендуется)
   - Используйте сервисы типа Datadog, New Relic, или Grafana Cloud
   - Настройте алерты на медленные запросы и ошибки

2. **Логирование в Supabase**
   - Регулярно проверяйте логи Edge Functions
   - Настройте уведомления на критические ошибки

3. **Периодическая очистка**
   - Метрики хранятся в памяти (до 10,000 записей)
   - Старые метрики автоматически удаляются

### Пример настройки алертов

```yaml
# Datadog Monitor
- name: Smart Tasbih API P95 > 150ms
  query: avg(smart_tasbih_api.duration.p95) > 150
  alert: true

- name: Smart Tasbih API Error Rate > 1%
  query: sum(smart_tasbih_api.errors) / sum(smart_tasbih_api.requests) > 0.01
  alert: true
```

## Улучшения

### Текущие ограничения

1. **Хранение в памяти** - метрики теряются при перезапуске
2. **Нет персистентности** - нет долгосрочного хранения
3. **Нет визуализации** - только JSON ответы

### Планируемые улучшения

1. **Интеграция с Supabase Database**
   - Сохранение метрик в таблицу `api_metrics`
   - Долгосрочное хранение и анализ

2. **Дашборд метрик**
   - Визуализация в Supabase Dashboard
   - Графики производительности

3. **Автоматические алерты**
   - Уведомления в Telegram/Email
   - При превышении пороговых значений

## Примеры использования

### Проверка производительности конкретного эндпоинта

```typescript
import { getEndpointMetrics } from "./monitoring.ts";

const metrics = getEndpointMetrics("/counter/tap", "POST", 60);
console.log(`P95: ${metrics.p95_duration_ms}ms`);
```

### Очистка старых метрик

```typescript
import { cleanupOldMetrics } from "./monitoring.ts";

// Удалить метрики старше 24 часов
cleanupOldMetrics(1440);
```

## Заключение

Модуль мониторинга обеспечивает:
- ✅ Автоматическое отслеживание производительности
- ✅ Логирование медленных запросов и ошибок
- ✅ Агрегацию метрик за период
- ✅ Вычисление перцентилей

**Следующие шаги:**
1. Настроить внешний мониторинг (Datadog/New Relic)
2. Создать дашборд для визуализации
3. Настроить алерты на критические показатели

